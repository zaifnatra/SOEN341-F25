<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Concordia University Campus Event Ticketing - Account</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  
  <div class="title-bar">CONCORDIA UNIVERSITY: CAMPUS EVENT TICKETING</div>

 
  <div class="navbar">
      <a href="index.html">HOME</a>
      <a href="/account" id="account-link" class="active">ACCOUNT</a>
      <a href="/eventspage">EVENTS</a>
      <a id="dashboard-link" href="#">DASHBOARD</a>
      <a href="recommended.html" id="for-you-link" style="display:none;">FOR YOU</a>
      <a href="help.html">HELP</a>
  </div>

  
  <div class="account-page">
    
    <div class="profile-card">
      <div class="profile-avatar">ðŸ‘¤</div>
      <h2 id="profile-name">Loading...</h2>
      <p id="profile-role">Role</p>
      <p id="profile-email">Email</p>
    </div>

    <div class="welcome-box2" id="student-welcome-box" style="display:none;">
      <h2>Welcome to your Campus Event Ticketing Account!</h2>
      <p> Claim tickets to your registered events and manage your interests.
         You can also request organizer access if youâ€™d like to host your own events or be part of an existing event.</p>
    </div>

    <div class="welcome-box2" id="organizer-welcome-box" style="display:none;">
      <h2>Welcome to your Campus Event Ticketing Account!</h2>
      <p> Create new events or modify your access privileges using the tools on the left.</p>
    </div>
  </div>

  <footer>
    <p>Â© 2025 Concordia University Campus Event Ticketing | All Rights Reserved</p>
  </footer>

  <div id="auth-btn-container"></div>
  <script src="signout.js"></script>
  <script src="index_role.js"></script>

  <script>
    //  Load Events for Organizer Form 
    async function loadExistingEvents(role, userEmail, username, selectElement) {
      try {
        const res = await fetch('/events');
        const events = await res.json();
        selectElement.innerHTML = "";

        const addedEventIds = new Set();
        events.forEach(event => {

          if (addedEventIds.has(event._id)) {
            return;
          }
          // For issue #171 : Organizers modification access

          if (role == "organizer") {
            if (event.organizer && Array.isArray(event.organizer) && event.organizer.length>0) {
              if (event.organizer[0] === username) {
                return;
              }
            }
            if (event.organizer && (event.organizer.includes(username) || event.organizer.includes(userEmail))) {
              return;
            }

            const option = document.createElement('option');
            option.value = event._id;
            option.textContent = event.title;
            selectElement.appendChild(option);
            addedEventIds.add(event._id);
            return;
          }

          // For students: show events they're not already organizing
          if (event.organizer && event.organizer.includes(userEmail))
          return;

          const option = document.createElement('option');
          option.value = event._id;
          option.textContent = event.title;
          selectElement.appendChild(option);
          addedEventIds.add(event._id);
        });
      } catch {
        console.error("Failed to load events.");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      let currentUser = null;

      // Fetch User Profile 
      try {
        const res = await fetch('/user-profile');
        currentUser = await res.json();
        document.getElementById('profile-name').textContent = currentUser.username || 'Username';
        document.getElementById('profile-email').textContent = currentUser.email || 'Email';
        document.getElementById('profile-role').textContent =
          currentUser.role ? currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1) : 'Role';
      } catch {
        console.error("Failed to load user profile.");
      }

      const role = currentUser?.role;
      const profileCard = document.querySelector(".profile-card");
      const studentBox = document.getElementById("student-welcome-box");
      const organizerBox = document.getElementById("organizer-welcome-box");

      // Role-based Buttons 
      if (role === "student") {
        studentBox.style.display = "block";
        document.getElementById("for-you-link").style.display = "inline-block";

        // My Events
        const myEventsBtn = document.createElement("a");
        myEventsBtn.href = "MyEvents.html";
        myEventsBtn.className = "profile-btn";
        myEventsBtn.textContent = "ðŸŽŸ My Events";
        profileCard.appendChild(myEventsBtn);

        // Request Organizer Access
        const requestBtn = document.createElement("button");
        requestBtn.id = "request-btn";
        requestBtn.className = "profile-btn secondary";
        requestBtn.textContent = "Request Organizer Access";
        profileCard.appendChild(requestBtn);
        requestBtn.addEventListener("click", showOrganizerAccessForm);

        // Modify Interests
        const modifyBtn = document.createElement("button");
        modifyBtn.id = "modify-interests-btn";
        modifyBtn.className = "profile-btn secondary";
        modifyBtn.textContent = "Modify Interests";
        profileCard.appendChild(modifyBtn);
        modifyBtn.addEventListener("click", showModifyInterestsForm);
      }

      if (role === "organizer") {
        organizerBox.style.display = "block";
        document.getElementById("for-you-link").style.display = "none";

        // Modify Access
        const modifyAccessBtn = document.createElement("button");
        modifyAccessBtn.id = "request-btn";
        modifyAccessBtn.className = "profile-btn secondary";
        modifyAccessBtn.textContent = "Modify Access";
        profileCard.appendChild(modifyAccessBtn);
        modifyAccessBtn.addEventListener("click", showOrganizerAccessForm);

        // Create Event
        const createBtn = document.createElement("a");
        createBtn.href = "create-event.html";
        createBtn.className = "profile-btn";
        createBtn.textContent = "Create Event";
        profileCard.appendChild(createBtn);
      }

      // Modify Interests Form 
      function showModifyInterestsForm() {
        hideAllBoxes();
        const rightBox = document.createElement("div");
        rightBox.className = "welcome-box2";
        rightBox.id = "dynamic-box";
        rightBox.innerHTML = `
          <h2>Modify Your Interests</h2>
          <form id="interests-form">
            <div class="interests-container" style="text-align:left;max-width:300px;margin:20px auto;">
              <label><input type="checkbox" value="Academic"> Academic</label><br>
              <label><input type="checkbox" value="Social"> Social</label><br>
              <label><input type="checkbox" value="Workshop"> Workshop</label><br>
              <label><input type="checkbox" value="Sports"> Sports</label><br>
              <label><input type="checkbox" value="Career"> Career</label><br>
              <label><input type="checkbox" value="Arts"> Arts</label><br>
              <label><input type="checkbox" value="Other"> Other</label><br>
            </div>
            <button type="submit" class="profile-btn" style="width:auto;padding:8px 20px;">Save Interests</button>
          </form>
          <p id="interest-update-msg" style="color:green;margin-top:10px;"></p>
        `;
        document.querySelector(".account-page").appendChild(rightBox);

        if (currentUser && currentUser.interests) {
          currentUser.interests.forEach(interest => {
            const box = document.querySelector(`input[value="${interest}"]`);
            if (box) box.checked = true;
          });
        }

        document.getElementById("interests-form").addEventListener("submit", async e => {
          e.preventDefault();
          const selected = Array.from(document.querySelectorAll("#interests-form input[type='checkbox']:checked"))
            .map(i => i.value);
          try {
            const res = await fetch("/api/update-interests", {
              method: "POST",
              headers: {"Content-Type":"application/json"},
              body: JSON.stringify({ interests: selected })
            });
            const data = await res.json();
            const msg = document.getElementById("interest-update-msg");
            if (res.ok) {
              msg.textContent = "Interests updated successfully!";
              msg.style.color = "green";
              currentUser.interests = selected;
              setTimeout(() => resetRightBox(role), 1500);
            } else {
              msg.textContent = data.message || "Failed to update.";
              msg.style.color = "red";
            }
          } catch {
            msg.textContent = "An error occurred.";
          }
        });
      }

      // Organizer Access Form 
// Replace your existing showOrganizerAccessForm() with this:
function showOrganizerAccessForm() {
  hideAllBoxes();
  const rightBox = document.createElement("div");
  rightBox.className = "welcome-box2";
  rightBox.id = "dynamic-box";
  const isOrganizer = (role === "organizer");

  rightBox.innerHTML = `
    <h2>${isOrganizer ? "Modify Organizer Access" : "Request Organizer Access"}</h2>
    <form id="organizer-form">
      ${
        isOrganizer
          ? `<p>Select the events you want to get access to </p>`
          : `
            <label><input type="radio" name="orgType" value="new" checked> Become a new Organizer.</label><br><br>
            <label><input type="radio" name="orgType" value="existing"> Organize existing events:</label><br><br>
          `
      }
      <select id="existingEventsSelect" multiple size="5" style="width:80%;padding:6px;margin-bottom:10px;"></select><br>
      <button type="submit" class="profile-btn" style="width:auto;padding:8px 20px;">Submit</button>
    </form>
    <p id="org-request-msg" style="color:green;margin-top:10px;"></p>
  `;

  document.querySelector(".account-page").appendChild(rightBox);

  const select = document.getElementById("existingEventsSelect");
  if (currentUser) loadExistingEvents(currentUser.role, currentUser.email, currentUser.username, select);

  // Helper to fully disable/enable the select reliably
  function setSelectEnabled(enabled) {
    // Real disabled attribute (prevents normal interaction)
    select.disabled = !enabled;

    // ARIA & tabindex: make it un-focusable for keyboard users when disabled
    if (!enabled) {
      select.setAttribute("aria-disabled", "true");
      select.setAttribute("tabindex", "-1");
    } else {
      select.removeAttribute("aria-disabled");
      select.removeAttribute("tabindex");
    }

    // Visual cue
    select.style.opacity = enabled ? "1" : "0.6";
    select.style.cursor = enabled ? "auto" : "not-allowed";

    // Remove any selections when disabling
    if (!enabled) {
      Array.from(select.options).forEach(opt => opt.selected = false);
    }
  }

  // Prevent mouse / keyboard events that might change selection even if something goes wrong
  function blockInteractionIfDisabled(e) {
    if (select.disabled) {
      // For pointer events like mousedown/click, prevent default so focus/select doesn't happen
      if (e.type === "mousedown" || e.type === "click") {
        e.preventDefault();
        e.stopPropagation();
      }
      // For keyboard events (space/arrow) prevent changing selection
      if (e.type === "keydown") {
        const keysToBlock = [" ", "Spacebar", "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", "Home", "End", "PageUp", "PageDown"];
        if (keysToBlock.includes(e.key)) {
          e.preventDefault();
          e.stopPropagation();
        }
      }
    }
  }

  // Only run radio logic for non-organizers
  if (!isOrganizer) {
    const radios = document.querySelectorAll('input[name="orgType"]');

    // Initially, "new" is checked â€” disable the select
    setSelectEnabled(false);

    // Attach radio change handlers
    radios.forEach(radio => {
      radio.addEventListener("change", e => {
        const enable = e.target.value === "existing";
        setSelectEnabled(enable);
      });
    });

    // Also guard the select itself from unexpected interactions
    select.addEventListener("mousedown", blockInteractionIfDisabled);
    select.addEventListener("click", blockInteractionIfDisabled);
    select.addEventListener("keydown", blockInteractionIfDisabled);
    // In case focus happens via scripting, blur it when disabled
    select.addEventListener("focus", () => { if (select.disabled) select.blur(); });
  }

  // Always validate again on submit (defensive)
  document.getElementById("organizer-form").addEventListener("submit", async e => {
    e.preventDefault();

    // Recompute selected after final state
    const selected = Array.from(select.selectedOptions).map(opt => opt.value);
    let requests = [];

    if (isOrganizer) {
      if (selected.length === 0) {
        alert("Select at least one event to modify access.");
        return;
      }
      requests = selected.map(eventId => ({ type: "existing", eventId }));
    } else {
      const type = document.querySelector('input[name="orgType"]:checked').value;
      if (type === "new") {
        requests.push({ type: "new", eventId: null });
      } else if (type === "existing") {
        if (selected.length === 0) return alert("Select at least one event.");
        requests = selected.map(eventId => ({ type: "existing", eventId }));
      } else {
        return alert("Select organizer type.");
      }
    }

    // send request
    try {
      const res = await fetch("/request-organizer", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ requests })
      });
      const data = await res.json();
      const msg = document.getElementById("org-request-msg");
      if (res.ok) {
        msg.textContent = data.message || "Access updated successfully!";
        msg.style.color = "green";
        setTimeout(() => resetRightBox(role), 1500);
      } else {
        msg.textContent = data.message || "Failed to submit.";
        msg.style.color = "red";
      }
    } catch {
      document.getElementById("org-request-msg").textContent = "An error occurred.";
    }
  });
}

      // 
      function hideAllBoxes() {
        document.querySelectorAll(".welcome-box2").forEach(box => box.style.display = "none");
        const existingDynamic = document.getElementById("dynamic-box");
        if (existingDynamic) existingDynamic.remove();
      }

      function resetRightBox(role) {
        hideAllBoxes();
        if (role === "student") studentBox.style.display = "block";
        else if (role === "organizer") organizerBox.style.display = "block";
      }
    });
  </script>
</body>
</html>
