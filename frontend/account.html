<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <title>Concordia University Campus Event Ticketing - Account</title>
Â  <link rel="stylesheet" href="style.css">
</head>
<body>

Â  <div class="title-bar">CONCORDIA UNIVERSITY: CAMPUS EVENT TICKETING</div>

Â  <div class="navbar">
Â  Â  Â  <a href="index.html">HOME</a>
Â  Â  Â  <a href="/account">ACCOUNT</a>
Â  Â  Â  <a href="/eventspage">EVENTS</a>
Â  Â  Â  <a id="dashboard-link" href="#">DASHBOARD</a>
Â  Â  Â  <a href="/recommended" id="for-you-link" style="display:none;">FOR YOU</a>
Â  Â  Â  <a href="help.html">HELP</a>
Â  </div>
Â  
<div class="account-hub">

  Â  <div class="profile-box" id="profile-box-container">
Â  Â  <h2>MY PROFILE</h2>
Â  Â  <div class="profile-icon">ðŸ‘¤</div>
Â  Â  <p id="profile-name">Loading...</p>
Â  Â  <p id="profile-email">Loading...</p>
Â  Â  <p id="profile-role">Loading...</p>
Â  </div>

  <div id="my-interests-container" style="display:none;"> <h2>MY INTERESTS</h2>
Â  Â  <form id="interests-form">
Â  Â  Â  <div class="interests-container" style="text-align: left; max-width: 300px; margin: 10px auto; padding-left: 20px;">
Â  Â  Â  Â  <label><input type="checkbox" id="Academic" value="Academic"> Academic</label><br>
Â  Â  Â  Â  <label><input type="checkbox" id="Social" value="Social"> Social</label><br>
Â  Â  Â  Â  <label><input type="checkbox" id="Workshop" value="Workshop"> Workshop</label><br>
Â  Â  Â  Â  <label><input type="checkbox" id="Sports" value="Sports"> Sports</label><br>
Â  Â  Â  Â  <label><input type="checkbox" id="Career" value="Career"> Career</label><br>
Â  Â  Â  Â  <label><input type="checkbox" id="Arts" value="Arts"> Arts</label><br>
Â  Â  Â  Â  <label><input type="checkbox" id="Other" value="Other"> Other</label><br>
Â  Â  Â  </div>
Â  Â  Â  <button type="submit" id="btn" style="width: auto; padding: 10px 20px;">Update Interests</button>
Â  Â  </form>
Â  Â  <p id="interest-update-msg" style="color: green;"></p>
  </div>

  <div class="option-box" id="my-events-option" style="display:none;">
    <a href="MyEvents.html">
Â  Â  Â  <img src="calendar.png" alt="events">
Â  Â  Â  <p>MY EVENTS</p>
    </a>
Â  </div>

  <div class="option-box" id="create-event-option" style="display:none;">
    <a href="create-event.html">
Â  Â  Â  <img src="create-event.png" alt="create event">
Â  Â  Â  <p>CREATE EVENT</p>
Â  Â  </a>
  </div>

  Â  <div id="organizer-request-section" style="display:none;">
Â  Â  <h3>Request Organizer Access</h3>
Â  Â  <label>
Â  Â  Â  <input type="radio" name="orgRequestType" value="new" checked>
Â  Â  Â  I want to become a new Organizer.
Â  Â  </label>
Â  Â  <br>
Â  Â  <label>
Â  Â  Â  <input type="radio" name="orgRequestType" value="existing">
Â  Â  Â  I want to organize existing events:
Â  Â  </label>
Â  Â  <div class="existing-list-wrapper">
Â  Â  Â  <select id="existingEventsSelect" multiple size="5" disabled>
Â  Â  Â  </select>
Â  Â  </div>
Â  Â  <br>
Â  Â  <button id="submitOrgRequest">Submit Request</button>
Â  </div>

</div> <footer>
Â  <p>Â© 2025 Concordia University Campus Event Ticketing | All Rights Reserved</p>
</footer>

<div id="auth-btn-container"></div>
<script src="signout.js"></script>
<script src="index_role.js"></script>


<script>
  // --- Helper function to load events for the dropdown ---
Â  function loadExistingEvents(role, userEmail) {
Â  Â  fetch('/events')
Â  Â  Â  .then(res => res.json())
Â  Â  Â  .then(events => {
Â  Â  Â  Â  const select = document.getElementById('existingEventsSelect');
Â  Â  Â  Â  select.innerHTML = "";
Â  Â  Â  Â  events.forEach(event => {
Â  Â  Â  Â  Â  if (role === "organizer" && event.organizer && event.organizer.includes(userEmail)) {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  option.value = event._id;
Â  Â  Â  Â  Â  option.textContent = event.title;
Â  Â  Â  Â  Â  select.appendChild(option);
Â  Â  Â  Â  });
Â  Â  Â  });
Â  }

  // --- Main script to run when page loads ---
Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  
Â  Â  // 1. Fetch user data
Â  Â  fetch('/user-profile')
Â  Â  Â  .then(res => res.json())
Â  Â  Â  .then(user => {
        
        // --- PART A: Populate "My Profile" Box ---
        document.getElementById('profile-name').textContent = user.username || 'Username';
        document.getElementById('profile-email').textContent = user.email || 'Email';
        document.getElementById('profile-role').textContent = user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : 'Role';

        // --- PART B: Populate "My Interests" Box (if it's visible) ---
       // normalize interests to an array (handles array, string, null/undefined)
        const interests = Array.isArray(user.interests)
          ? user.interests.map(String).map(s => s.trim()).filter(Boolean)
          : (typeof user.interests === 'string' && user.interests.trim()
              ? user.interests.split(',').map(s => s.trim()).filter(Boolean)
              : []);

        // mark checkboxes
        interests.forEach(interest => {
          const checkbox = document.getElementById(String(interest));
          if (checkbox) checkbox.checked = true;
        });

        // --- PART C: Show/Hide Widgets based on NEW Role Logic ---
        const role = user.role;
        
        if (role === 'admin') {
          // Admin: My Profile, Create Event
          document.getElementById('create-event-option').style.display = 'flex';
        
        } else if (role === 'organizer') {
          // Organizer: My Profile, My Events, Create Event, Request
          document.getElementById('my-events-option').style.display = 'flex';
          document.getElementById('create-event-option').style.display = 'flex';
          document.getElementById('organizer-request-section').style.display = 'block';
          loadExistingEvents(user.role, user.email);
        
        } else if (role === 'student') {
          // Student: My Profile, My Events, My Interests, Request
          document.getElementById('my-events-option').style.display = 'flex';
          document.getElementById('my-interests-container').style.display = 'block';
          document.getElementById('organizer-request-section').style.display = 'block';
          loadExistingEvents(user.role, user.email);
        }
Â  Â  Â  })
      .catch(err => {
        console.error("Failed to load user profile", err);
        document.getElementById('profile-name').textContent = 'Error';
      });

Â  Â  // 2. Add functionality to "My Interests" form
Â  Â  const form = document.getElementById("interests-form");
Â  Â  form.addEventListener("submit", async (e) => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const selectedInterests = [];
Â  Â  Â  form.querySelectorAll('input[type="checkbox"]:checked').forEach(box => {
Â  Â  Â  Â  selectedInterests.push(box.value);
Â  Â  Â  });

Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch('/api/update-interests', {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  body: JSON.stringify({ interests: selectedInterests })
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  const msgEl = document.getElementById("interest-update-msg");
Â  Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  Â  msgEl.textContent = "Interests updated successfully!";
Â  Â  Â  Â  Â  msgEl.style.color = "green";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  msgEl.textContent = data.message || "Failed to update.";
Â  Â  Â  Â  Â  msgEl.style.color = "red";
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  document.getElementById("interest-update-msg").textContent = "An error occurred.";
	  }
Â  Â  });

    // 3. Add functionality to "Request Organizer" form
Â  Â  const radios = document.querySelectorAll('input[name="orgRequestType"]');
Â  Â  const eventsSelect = document.getElementById('existingEventsSelect');
Â  Â  radios.forEach(radio => {
Â  Â  Â  radio.addEventListener('change', () => {
Â  Â  Â  Â  eventsSelect.disabled = radio.value !== 'existing';
 Â  Â  });
Â  Â  });

Â  Â  document.getElementById('submitOrgRequest').addEventListener('click', () => {
Â  Â  Â  const type = document.querySelector('input[name="orgRequestType"]:checked').value;
Â  Â  Â  const selectedOptions = Array.from(eventsSelect.selectedOptions).map(opt => opt.value);
Â  Â  Â  let requests = [];
Â  Â  Â  if (type === "new") {
Â  Â  Â  Â  requests.push({ type: "new", eventId: null });
} else if (type === "existing" && selectedOptions.length > 0) {
Â  Â  Â  Â  requests = selectedOptions.map(eventId => ({ type: "existing", eventId }));
Â  Â  Â  } else {
Â  Â  Â  Â  return alert("Select at least one event.");
Â  Â  Â  }
Â  Â  Â  fetch('/request-organizer', {
Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  headers: {'Content-Type':'application/json'},
BODY: JSON.stringify({ requests })
Â  Â  Â  })
Â  Â  Â  .then(res => res.json())
Â  Â  Â  .then(data => alert(data.message))
Â  Â  Â  .catch(() => alert("Request failed"));
Â  Â  });
  });
</script>

</body>
</html>