<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Concordia University - Events</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="title-bar">CONCORDIA UNIVERSITY: CAMPUS EVENT TICKETING</div>

 
  <div class="navbar">
    <a href="index.html">HOME</a>
    <a href="/account">ACCOUNT</a>
    <a href="/eventspage" class="active">EVENTS</a>
    <a id="dashboard-link" href="#">DASHBOARD</a>
    <a href="/recommended" id="for-you-link" style="display:none;">FOR YOU</a>
    <a href="help.html">HELP</a>
  </div>

   <div id="auth-btn-container"></div>


<div class="filter-container">
  <input 
      type="text" 
      id="filter-name" 
      placeholder="Search by event name..."
  >
  
  <input type="date" id="filter-date">
  
  <select id="filter-category">
    <option value="">All Categories</option>
  </select>
  
  <select id="filter-payment">
    <option value="">All Prices</option>
    <option value="Free">Free</option>
    <option value="Paid">Paid</option>
  </select>
  
  <select id="filter-organizer">
    <option value="">All Organizers</option>
  </select>
  
  <button id="clear-btn" class="filter-button">Clear</button>
</div>

  
  <div class="events-container" id="events-list">
    <p>Loading events...</p>
  </div>


  <footer>
    <p>© 2025 Concordia University Campus Event Ticketing | All Rights Reserved</p>
  </footer>

  <script src="index_role.js"></script>
  <script src="createevent.js"></script>
  <script src="signout.js"></script>

 <script>
  // Global variables to store our data
  let allEvents = [];
  let userRole = null;
  let userFavorites = [];

  /**
   * Populates all filter dropdowns
   */
  function populateFilters(events) {
    const categorySelect = document.getElementById("filter-category");
    const orgSelect = document.getElementById("filter-organizer");
    const paymentSelect = document.getElementById("filter-payment");

    // Clear existing options
    categorySelect.innerHTML = '<option value="">All Categories</option>';
    orgSelect.innerHTML = '<option value="">All Organizers</option>';
    paymentSelect.innerHTML = '<option value="">All Prices</option>';
    
    const allCategories = new Set();
    const allOrganizers = new Set();
    const allPaymentTypes = new Set();
    
    events.forEach(ev => {
      if (ev.type) allCategories.add(ev.type);
      if (ev.paymentStatus) allPaymentTypes.add(ev.paymentStatus);

      if (Array.isArray(ev.organizer)) {
        ev.organizer.forEach(org => allOrganizers.add(org));
      } else if (ev.organizer) {
        allOrganizers.add(ev.organizer);
      }
    });
    
    allCategories.forEach(category => {
      const option = document.createElement("option");
      option.value = category;
      option.textContent = category;
      categorySelect.appendChild(option);
    });
    
    allOrganizers.forEach(org => {
      const option = document.createElement("option");
      option.value = org;
      option.textContent = org;
      orgSelect.appendChild(option);
    });

    allPaymentTypes.forEach(payment => {
      const option = document.createElement("option");
      option.value = payment;
      option.textContent = payment;
      paymentSelect.appendChild(option);
    });
  }

  /**
   * Renders the event cards with all new logic
   */
  function renderEvents(eventsToRender, role, favorites) {
    const eventsList = document.getElementById("events-list");
    eventsList.innerHTML = ""; 

    if (!Array.isArray(eventsToRender) || eventsToRender.length === 0) {
      eventsList.innerHTML = "<p>No events found matching your criteria.</p>";
      return;
    }

    eventsToRender.forEach((ev) => {
      const card = document.createElement("div");
      card.classList.add("event-card");

      // --- 1. NEW LOGIC FOR DATE ---
      let dateString = ev.date || "No date";
      if (ev.endDate && ev.endDate !== ev.date) {
        dateString = `${ev.date} to ${ev.endDate}`; // Multi-day
      }
      
      // --- 2. NEW LOGIC FOR PRICE ---
      let priceString = "Free";
      if (ev.paymentStatus === "Paid" && ev.price) {
        priceString = `$${Number(ev.price).toFixed(2)}`; // Format price
      } else if (ev.paymentStatus === "Paid") {
        priceString = "Paid (Price TBD)"; // Fallback
      }

      // --- 3. NEW LOGIC FOR TIME ---
      let timeString = ev.time || "N/A";
      if (timeString.toLowerCase() === "all day") {
        timeString = "All Day";
      }

      // --- 4. UPDATED HTML ---
      card.innerHTML = `
        <h3>${ev.title || "Untitled Event"}</h3>
        <p><strong>Date:</strong> ${dateString}</p>
        <p><strong>Time:</strong> ${timeString}</p>
        <p><strong>Location:</strong> ${ev.location || "N/A"}</p>
        <p>${ev.description || ""}</p>
        <p><strong>Category:</strong> ${ev.type || 'N/A'}</p>
        <p><strong>Price:</strong> ${priceString}</p>
        <p><strong>Remaining:</strong> ${ev.remainingTickets ?? ev.capacity}</p>
      `;

      if (ev.qrCodes && ev.qrCodes.length > 0) {
        const qrImg = document.createElement("img");
        qrImg.src = ev.qrCodes[0].image;
        qrImg.alt = "QR Code sample";
        qrImg.classList.add("qr-sample");
        qrImg.style.width = "100px";
        qrImg.style.margin = "10px auto 5px";
        card.appendChild(qrImg);
      }

      // --- STUDENT FAVORITE BUTTON ---
      if (role === "student") {
        const favBtn = document.createElement("button");
        let isFavorited = favorites.includes(ev._id);
        favBtn.textContent = isFavorited ? "UNFAVORITE" : "FAVORITE";
        favBtn.classList.add("favorite-btn");
        favBtn.style.margin = "5px auto";

        favBtn.addEventListener("click", async () => {
          try {
            const res = await fetch("/api/toggle-favorite", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ eventId: ev._id })
            });
            const data = await res.json();
            if (data.success) {
              isFavorited = data.isFavorited;
              favBtn.textContent = isFavorited ? "UNFAVORITE" : "FAVORITE";
              if (isFavorited) {
                userFavorites.push(ev._id);
              } else {
                const index = userFavorites.indexOf(ev._id);
                if (index > -1) userFavorites.splice(index, 1);
              }
            } else {
              alert(data.message || "Could not update favorite.");
            }
          } catch (err) {
            console.error("Error toggling favorite:", err);
            alert("Could not update favorite.");
          }
        });
        card.appendChild(favBtn);
      }

      // --- STUDENT SIGNUP BUTTON ---
      if (role === "student") {
        const signUpBtn = document.createElement("button");
        signUpBtn.textContent = "Sign Up";
        signUpBtn.classList.add("signup-btn");
        signUpBtn.style.margin = "0 auto";

          signUpBtn.addEventListener("click", async () => {
          const isFree = ev.paymentStatus && ev.paymentStatus.toLowerCase() === "free";
          if (isFree) {
            try {
              const res = await fetch("/signup-event", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ eventId: ev._id })
              });
              const data = await res.json();
           
              // --- FIX: Moved alert logic inside the if/else ---
              if (res.ok && data.success) {
                alert(data.message); // Show success message
                ev.remainingTickets = (ev.remainingTickets ?? ev.capacity) - 1;
                applyFilters();
              } else {
                // This will show "You already signed up" or other errors
               alert(data.message || "Error signing up for this event.");
              }
            } catch (err) {
              console.error("Error signing up:", err);
              alert("Error signing up for the event.");
            }
          } else {
            window.location.href = `/payment.html?eventId=${ev._id}`;
         }
        });
        card.appendChild(signUpBtn);
      }

      // --- ADMIN DELETE BUTTON ---
      if (role === "admin") {
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete Event";
        delBtn.classList.add("delete-btn");
        delBtn.style.marginTop = "10px";
        delBtn.onclick = async () => {
          if (confirm(`Delete event "${ev.title}"?`)) {
            try {
              const res = await fetch(`/delete-event/${ev._id}`, { method: "DELETE" });
              const data = await res.json();
              alert(data.message);
              allEvents = allEvents.filter(e => e._id !== ev._id);
              applyFilters(); 
            } catch (err) {
              console.error("Error deleting event:", err);
              alert("Failed to delete event.");
            }
          }
        };
        card.appendChild(delBtn);
      }

      eventsList.appendChild(card);
    });
  }

  /**
   * Fetches all data, stores it, and does the *first* render
   */
  async function loadEvents() {
    const eventsList = document.getElementById("events-list");
    eventsList.innerHTML = "<p>Loading events...</p>";
    try {
      const [user, response] = await Promise.all([
        fetch("/user-profile").then(res => res.json()),
        fetch("/events")
      ]);
      
      if (!response.ok) throw new Error(`Failed to fetch events: ${response.statusText}`);
      const events = await response.json();

      userRole = user.role;
      userFavorites = user.favoritedEvents || [];
      allEvents = Array.isArray(events) ? events : [];

      populateFilters(allEvents);
      renderEvents(allEvents, userRole, userFavorites);

    } catch (error) {
      console.error("Error loading events:", error);
      eventsList.innerHTML = "<p>Error fetching events. Please try again later.</p>";
    }
  }

  /**
   * Applies all active filters
   */
  function applyFilters() {
    const nameValue = document.getElementById("filter-name").value.toLowerCase();
    const categoryValue = document.getElementById("filter-category").value;
    const dateValue = document.getElementById("filter-date").value;
    const paymentValue = document.getElementById("filter-payment").value;
    const orgValue = document.getElementById("filter-organizer").value;

    let filteredEvents = allEvents;

    if (nameValue) {
      filteredEvents = filteredEvents.filter(ev => ev.title && ev.title.toLowerCase().includes(nameValue));
    }
    if (categoryValue) {
      filteredEvents = filteredEvents.filter(ev => ev.type === categoryValue);
    }
    if (dateValue) {
      filteredEvents = filteredEvents.filter(ev => ev.date === dateValue);
  T }
    if (paymentValue) {
      filteredEvents = filteredEvents.filter(ev => ev.paymentStatus === paymentValue);
    }
    if (orgValue) {
      filteredEvents = filteredEvents.filter(ev =>
        (Array.isArray(ev.organizer) && ev.organizer.includes(orgValue)) ||
        (ev.organizer === orgValue)
      );
    }

    renderEvents(filteredEvents, userRole, userFavorites);
  }

  /**
   * Clears all filter inputs
   */
  function clearFilters() {
    document.getElementById("filter-name").value = "";
    document.getElementById("filter-category").value = "";
  Note.getElementById("filter-date").value = "";
    document.getElementById("filter-payment").value = "";
    document.getElementById("filter-organizer").value = "";
    renderEvents(allEvents, userRole, userFavorites);
  }

  // --- Main startup ---
  window.onload = () => {
    loadEvents();
    checkUserInterests(); 

    // Add listeners for all filters
    document.getElementById('clear-btn').addEventListener('click', clearFilters);
    document.getElementById('filter-name').addEventListener('input', applyFilters);
    document.getElementById('filter-category').addEventListener('change', applyFilters);
   document.getElementById('filter-date').addEventListener('input', applyFilters);
    document.getElementById('filter-payment').addEventListener('change', applyFilters);
  document.getElementById('filter-organizer').addEventListener('change', applyFilters);

    // Search query from homepage
    const params = new URLSearchParams(window.location.search);
    const query = params.get('search');
    if (query) {
      const filterInput = document.getElementById('filter-name');
      if (filterInput) {
        filterInput.value = query;
        applyFilters();
      }
    }
  };

  // --- Popup for new students ---
  async function checkUserInterests() {
    try {
      const asked = sessionStorage.getItem('askedForInterests');
      if (asked) return;
      const res = await fetch('/user-profile');
      const user = await res.json();
      if (user.role === 'student' && (!user.interests || user.interests.length === 0)) {
        sessionStorage.setItem('askedForInterests', 'true');
        const wantsToUpdate = confirm("We see you haven't set your event interests yet. Would you like to set them now to get better recommendations?");
        if (wantsToUpdate) {
          window.location.href = '/account';
        }
      }
    } catch (err) {
      console.error("Error checking user interests:", err);
    }
  }
  </script>