<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Concordia University - Events</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="title-bar">CONCORDIA UNIVERSITY: CAMPUS EVENT TICKETING</div>

 
  <div class="navbar">
    <a href="index.html">HOME</a>
    <a href="/account">ACCOUNT</a>
    <a href="/eventspage" class="active">EVENTS</a>
    <a id="dashboard-link" href="#">DASHBOARD</a>
    <a href="/recommended" id="for-you-link" style="display:none;">FOR YOU</a>
    <a href="help.html">HELP</a>
  </div>

   <div id="auth-btn-container"></div>


<div class="filter-container">
Â  <input 
Â  Â  Â  type="text" 
Â  Â  Â  id="filter-name" 
Â  Â  Â  placeholder="Search by event name..."
Â  >
Â  
Â  <input type="date" id="filter-date">
Â  
Â  <select id="filter-category">
Â  Â  <option value="">All Categories</option>
Â  </select>
Â  
Â  <select id="filter-payment">
Â  Â  <option value="">All Prices</option>
Â  Â  <option value="Free">Free</option>
Â  Â  <option value="Paid">Paid</option>
Â  </select>
Â  
Â  <select id="filter-organizer">
Â  Â  <option value="">All Organizers</option>
Â  </select>
Â  
Â  <button id="clear-btn" class="filter-button">Clear</button>
</div>

  
  <div class="events-container" id="events-list">
    <p>Loading events...</p>
  </div>


  <footer>
    <p>Â© 2025 Concordia University Campus Event Ticketing | All Rights Reserved</p>
  </footer>

  <script src="index_role.js"></script>
  <script src="createevent.js"></script>
  <script src="signout.js"></script>

 <script>
Â  // Global variables to store our data
Â  let allEvents = [];
Â  let userRole = null;
Â  let userFavorites = []; // Made global

Â  async function getUserRole() {
Â  Â  try {
Â  Â  Â  const res = await fetch("/user-profile");
Â  Â  Â  if (!res.ok) return null;
Â  Â  Â  const data = await res.json();
Â  Â  Â  return data.role || null;
Â  Â  } catch {
Â  Â  Â  return null;
Â  Â  }
Â  }

function populateFilters(events) {
Â  Â  const categorySelect = document.getElementById("filter-category");
Â  Â  const orgSelect = document.getElementById("filter-organizer");

Â  Â  categorySelect.innerHTML = '<option value="">All Categories</option>';
Â  Â  orgSelect.innerHTML = '<option value="">All Organizers</option>';
Â  Â  
Â  Â  const allCategories = new Set();
Â  Â  const allOrganizers = new Set();
Â  Â  
Â  Â  events.forEach(ev => {
Â  Â  Â  if (ev.type) {
Â  Â  Â  Â  allCategories.add(ev.type);
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  if (Array.isArray(ev.organizer)) {
Â  Â  Â  Â  ev.organizer.forEach(org => allOrganizers.add(org));
Â  Â  Â  } else if (ev.organizer) {
Â  Â  Â  Â  allOrganizers.add(ev.organizer);
Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  allCategories.forEach(category => {
Â  Â  Â  if (category) {
Â  Â  Â  Â  const option = document.createElement("option");
Â  Â  Â  Â  option.value = category;
Â  Â  Â  Â  option.textContent = category;
Â  Â  Â  Â  categorySelect.appendChild(option);
Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  allOrganizers.forEach(org => {
Â  Â  Â  if (org) {
Â  Â  Â  Â  const option = document.createElement("option");
Â  Â  Â  Â  option.value = org;
Â  Â  Â  Â  option.textContent = org; // This will now be the username
Â  Â  Â  Â  orgSelect.appendChild(option);
Â  Â  Â  }
Â  Â  });
Â  }

Â  /**
Â  Â * This function now just renders a given list of events
Â  Â */
Â  function renderEvents(eventsToRender, role, favorites) {
Â  Â  const eventsList = document.getElementById("events-list");
Â  Â  eventsList.innerHTML = ""; 

Â  Â  if (!Array.isArray(eventsToRender) || eventsToRender.length === 0) {
Â  Â  Â  eventsList.innerHTML = "<p>No events found matching your criteria.</p>";
Â  Â  Â  return;
Â  Â  }

Â  Â  eventsToRender.forEach((ev) => {
Â  Â  Â  const card = document.createElement("div");
Â  Â  Â  card.classList.add("event-card");

Â  Â  Â  const title = ev.title || "Untitled Event";
Â  Â  Â  const date = ev.date || "No date";
Â  Â  Â  const time = ev.time || "No time";
Â  Â  Â  const location = ev.location || "No location";
Â  Â  Â  const description = ev.description || "";
Â  Â  Â  const capacity = ev.capacity || 0;
Â  Â  Â  const type = ev.type || "N/A";
Â  Â  Â  const remaining = ev.remainingTickets ?? capacity;

Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  <h3>${title}</h3>
Â  Â  Â  Â  <p><strong>Date:</strong> ${date}</p>
Â  Â  Â  Â  <p><strong>Time:</strong> ${time}</p>
Â  Â  Â  Â  <p><strong>Location:</strong> ${location}</p>
Â  Â  Â  Â  <p>${description}</p>
Â  Â  Â  Â  <p><strong>Tickets:</strong> ${capacity}</p>
Â  Â  Â  Â  <p><strong>Remaining:</strong> ${remaining}</p>
Â  Â  Â  Â  <p><strong>Category:</strong> ${ev.type || 'N/A'}</p>
Â  Â  Â  Â  <p><strong>Price:</strong> ${ev.paymentStatus || 'Free'}</p>
Â  Â  Â  `;

Â  Â  Â  if (ev.qrCodes && ev.qrCodes.length > 0) {
Â  Â  Â  Â  const qrImg = document.createElement("img");
Â  Â  Â  Â  qrImg.src = ev.qrCodes[0].image;
Â  Â  Â  Â  qrImg.alt = "QR Code sample";
Â  Â  Â  Â  qrImg.classList.add("qr-sample");
Â  Â  Â  Â  qrImg.style.width = "100px";
Â  Â  Â  Â  qrImg.style.marginTop = "8px";
Â  Â  Â  Â  qrImg.style.display = "block";
Â  Â  Â  Â  qrImg.style.margin = "10px auto 5px";
Â  Â  Â  Â  card.appendChild(qrImg);
Â  Â  Â  }

Â  Â  Â  // --- STUDENT FAVORITE BUTTON ---
Â  Â  Â  if (role === "student") {
Â  Â  Â  Â  const favBtn = document.createElement("button");
Â  Â  Â  Â  
Â  Â  Â  Â  let isFavorited = favorites.includes(ev._id);
Â  Â  Â  Â  favBtn.textContent = isFavorited ? "â¤ï¸ Unfavorite" : "ðŸ¤ Favorite";
Â  Â  Â  Â  favBtn.classList.add("favorite-btn");
Â  Â  Â  Â  favBtn.style.marginTop = "5px";
Â  Â  Â  Â  favBtn.style.display = "block";
Â  Â  Â  Â  favBtn.style.margin = "5px auto";

Â  Â  Â  Â  favBtn.addEventListener("click", async () => {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const res = await fetch("/api/toggle-favorite", {
Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ eventId: ev._id })
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  isFavorited = data.isFavorited;
Â  Â  Â  Â  Â  Â  Â  favBtn.textContent = isFavorited ? "â¤ï¸ Unfavorite" : "ðŸ¤ Favorite";
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  if (isFavorited) {
Â  Â  Â  Â  Â  Â  Â  Â  userFavorites.push(ev._id);
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const index = userFavorites.indexOf(ev._id);
Â  Â  Â  Â  Â  Â  Â  Â  if (index > -1) userFavorites.splice(index, 1);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â   Â  Â  Â  }
Â  Â  Â  Â  Â   } catch (err) {
Â  Â  Â  Â  Â  Â  console.error("Error toggling favorite:", err);
Â  Â  Â  Â  Â  Â  alert("Could not update favorite.");
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  card.appendChild(favBtn);
Â  Â  Â  }

Â  Â  Â  // --- STUDENT SIGNUP BUTTON ---
Â  Â  Â  if (role === "student") {
Â  Â  Â  Â  const signUpBtn = document.createElement("button");
Â  Â  Â  Â  signUpBtn.textContent = "Sign Up";
Â  Â  Â  Â  signUpBtn.classList.add("signup-btn");
Â  Â  Â  Â  signUpBtn.style.display = "block";
Â  Â  Â  Â  signUpBtn.style.margin = "0 auto";

Â  Â  Â  Â  signUpBtn.addEventListener("click", async () => {
Â  Â  Â  Â  Â  // --- SAFETY FIX: Check if paymentStatus exists before checking its case
Â  Â  Â  Â  Â  const isFree = ev.paymentStatus && ev.paymentStatus.toLowerCase() === "free";
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (isFree) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const res = await fetch("/signup-event", {
Â  Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ eventId: ev._id })
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  alert(data.message);
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  if (res.ok && data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  ev.remainingTickets = (ev.remainingTickets ?? capacity) - 1;
Â  Â  Â  Â  Â  Â  Â  Â  applyFilters(); // Re-apply filters to update the card
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  console.error("Error signing up:", err);
Â  Â  Â  Â  Â  Â  Â  alert("Error signing up for the event.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Assumes any event that isn't "Free" is paid
Â  Â  Â  Â  Â  Â  window.location.href = `/payment.html?eventId=${ev._id}`;
Â  Â  Â  Â  Â  }
_ Â  Â  Â  });

Â  Â  Â  Â  card.appendChild(signUpBtn);
Â  Â  Â  }

Â  Â  Â  // --- ADMIN DELETE BUTTON ---
Â  Â  Â  if (role === "admin") {
Â  Â  Â  Â  const delBtn = document.createElement("button");
Â  Â  Â  Â  delBtn.textContent = "Delete Event";
Â  Â  Â  Â  delBtn.classList.add("delete-btn");
Â  Â  Â  Â  delBtn.style.marginTop = "10px";
Â  Â  Â  Â  delBtn.onclick = async () => {
Â  Â  Â  Â  Â  if (confirm(`Delete event "${title}"?`)) {
 Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const res = await fetch(`/delete-event/${ev._id}`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: "DELETE",
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  alert(data.message);
Â  Â  Â  Â  Â  Â  Â  allEvents = allEvents.filter(e => e._id !== ev._id);
Â  Â  Â  Â  Â  Â  Â  applyFilters(); 
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  console.error("Error deleting event:", err);
Â  Â  Â  Â  Â  Â  Â  alert("Failed to delete event.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  card.appendChild(delBtn);
Â  Â  Â  }

Â  Â  Â  eventsList.appendChild(card);
Â  Â  });
Â  }

Â  /**
Â  Â * Fetches all data, stores it, and does the *first* render
E Â */
Â  async function loadEvents() {
Â  Â  const eventsList = document.getElementById("events-list");
Â  Â  eventsList.innerHTML = "<p>Loading events...</p>";

Â  Â  try {
Â  Â  Â  const [user, response] = await Promise.all([
Â  Â  Â  Â  fetch("/user-profile").then(res => res.json()),
Â  Â  Â  Â  fetch("/events")
Â  Â  Â  ]);
Â  Â  Â  
Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  throw new Error(`Failed to fetch events: ${response.statusText}`);
Â  Â  Â  }

Â  Â  Â  const events = await response.json();

Â  Â  Â  userRole = user.role;
Â  Â  Â  userFavorites = user.favoritedEvents || [];
Â  Â  Â  
Â  Â  Â  if (Array.isArray(events)) {
 Â  Â  Â  allEvents = events; 
Â  Â  Â  } else {
Â  Â  Â  Â  Â  allEvents = [];
Â  Â  Â  }

Â  Â  Â  populateFilters(allEvents);
Â  Â  Â  renderEvents(allEvents, userRole, userFavorites);

Â  Â  } catch (error) {
Â  Â  Â  console.error("Error loading events:", error);
Â  Â  Â  eventsList.innerHTML = "<p>Error fetching events. Please try again later.</p>";
s Â  }
Â  }

/**
Â  Â * This function filters the `allEvents` array and calls renderEvents
Â  Â */
Â  function applyFilters() {
Â  Â  const nameValue = document.getElementById("filter-name").value.toLowerCase();
Â  Â  const categoryValue = document.getElementById("filter-category").value;
Â  Â  const dateValue = document.getElementById("filter-date").value;
Â  Â  const paymentValue = document.getElementById("filter-payment").value;
Â  Â  const orgValue = document.getElementById("filter-organizer").value;

Â  Â  let filteredEvents = allEvents;

Â  Â  if (nameValue) {
Â  Â  Â  filteredEvents = filteredEvents.filter(ev =>
Â  Â  Â  Â  ev.title && ev.title.toLowerCase().includes(nameValue)
Â  Â  Â  );
Â  Â  }

Â  Â  if (categoryValue) {
Â  Â  Â  filteredEvents = filteredEvents.filter(ev => ev.type === categoryValue);
Â  Â  }

Â  Â  if (dateValue) {
Â  Â  Â  filteredEvents = filteredEvents.filter(ev => ev.date === dateValue);
Â  Â  }

Â  Â  if (paymentValue) {
Â  Â  Â  filteredEvents = filteredEvents.filter(ev => ev.paymentStatus === paymentValue);
 Â  }

Â  Â  if (orgValue) {
Â  Â  Â  filteredEvents = filteredEvents.filter(ev =>
Â  Â  Â  Â  (Array.isArray(ev.organizer) && ev.organizer.includes(orgValue)) ||
Â  Â  Â  Â  (ev.organizer === orgValue)
Â  Â  Â  );
Â  Â  }

Â  Â  renderEvents(filteredEvents, userRole, userFavorites);
Â  }

/**
Â  Â * Clears inputs and shows all events again
Â  Â */
Â  function clearFilters() {
Â  Â  document.getElementById("filter-name").value = "";
Â  Â  document.getElementById("filter-category").value = "";
Â  Â  document.getElementById("filter-date").value = "";
Â  Â  document.getElementById("filter-payment").value = "";
Â  Â  document.getElementById("filter-organizer").value = "";

Â  Â  renderEvents(allEvents, userRole, userFavorites);
Â  }

Â  window.onload = () => {
Â  Â  loadEvents(); 
Â  Â  checkUserInterests(); 

Â  Â  // Attach listeners to all filter elements
Â  Â  document.getElementById('clear-btn').addEventListener('click', clearFilters);
Â  Â  document.getElementById('filter-name').addEventListener('input', applyFilters);
Â  Â  document.getElementById('filter-category').addEventListener('change', applyFilters);
Â  Â  document.getElementById('filter-date').addEventListener('input', applyFilters);
Â  Â  document.getElementById('filter-payment').addEventListener('change', applyFilters);
 Â  document.getElementById('filter-organizer').addEventListener('change', applyFilters);

Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  const query = params.get('search');
Â  Â  if (query) {
Â  Â  Â  const filterInput = document.getElementById('filter-name');
Â  Â  Â  if (filterInput) {
Â  Â  Â  Â  filterInput.value = query;
Â  Â  Â  Â  applyFilters();
Â  Â  Â  }
Â  Â  }
Â  };


Â  async function checkUserInterests() {
Â  Â  try {
Â  Â  Â  const asked = sessionStorage.getItem('askedForInterests');
Â  Â  Â  if (asked) {
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  const res = await fetch('/user-profile');
Â  Â  Â  const user = await res.json();

Â  Â  Â  if (user.role === 'student' && (!user.interests || user.interests.length === 0)) {
Â  Â  Â  Â  sessionStorage.setItem('askedForInterests', 'true');
Â  Â  Â  Â  const wantsToUpdate = confirm("We see you haven't set your event interests yet. Would you like to set them now to get better recommendations?");
Â  Â  Â  Â  
Â  Â  Â  Â  if (wantsToUpdate) {
Â  Â  Â  Â  Â  window.location.href = '/account';
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  console.error("Error checking user interests:", err);
Â  Â  }
Â  }
Â  </script>